# Requirement

## 前端
前端代码位于 `front` 目录下, 技术栈为:

- `vite@8`
- `vue3`
- `typescript`
- `inspira-ui`

对于 `vite` / `inspira-ui`, 在必要时可以调用 `context7` 获取官方文档

### 页面

#### 主页
标题: Smart Movie Game
副标题: AI 驱动的互动小说游戏生成器

- 顶部按钮:
  - 导入按钮: 用户可以上传之前生成的游戏 `json` 文件, 在校验完格式之后可以直接游玩

下方有两种模式:
- 向导模式
  - 游戏主题: 输入
  - 剧情简介: textarea, 可点击 AI 扩写剧情 按钮
  - 剧情类型: 以标签的形式点击选择(多选), 可以手动填写并添加新标签, 默认的可选项为:
    - 科幻
    - 剧情
    - 爱情
    - 悬疑
    - 喜剧
    - 青春
    - 历史
    - 冒险
    - 武侠
    - 伦理
    - 悲剧
    - 职场
  - 角色列表, 可点击 AI 扩写角色 按钮:
    - 名字: 输入
    - 身份/描述: 输入
    - 性别: 选择
    - 主角: switch
  - 目标: input
  - 叙事结构:
    - 故事线节点数量: 滑动选择最大和最小值, 范围是 5 ~ 50
    - 结局数量: 3 ~ 10
  - 生成剧情 按钮
- 自由输入:
  - 自由输入: textarea
  - 叙事结构:
    - 故事线节点数量: 滑动选择最大和最小值, 范围是 5 ~ 50
    - 结局数量: 3 ~ 10
  - 生成剧情 按钮

点击 **生成剧情** 按钮后, 会将填写的内容发送给后端, 后端要使用合适的提示词, 来生成互动电影类游戏的剧情, 返回给前端的是 json, 类型严格按照 `prompts/types/movie.ts` 中的类型(禁止返回 `nodes.shots`), 绝对不允许格式错误, 在提示词中必须明确说明应该返回 json, 并且提供类型

#### 游戏页
页面结构为:
- 主要内容区: 暗色背景, 每个角色都使用一个 svg(面部), 区分男女角色, 区分角色的表情
- 底部: 选择区域, 显示当前节点的可选项, 用户点击某个可选项之后, 进入对应的下一个节点
- 顶部右侧:
  - 导出按钮, 点击导出当前 `json`

#### 结局页
显示结局内容, 游戏统计信息和剧情树, 可点击 重新开始 / 重新创作 按钮

## 后端
后端代码位于 `server` 目录下, 语言为 `rust`, 使用 `axum` 框架

后端比较简单, 只是接收前端的请求, 并向 LLM 提供商 API 发起请求, API Key 使用 ``, 必须使用 `glm-4.6v-flash` 模型, 禁止修改模型名称

### 提示词
- 必须做好提示词防御, 必须保证提示词不被破解或绕过
- 参考 `prompts/WORKFLOW.md`, 不能完全照搬
- 必须根据前端主页的设置, 生成对应的提示词
- 这是一个互动电影类游戏, 是有多条故事线的, 必须明确的告诉模型, 必须有多个结局, 多条故事线

### 具体要求
- 游戏有完整的 **充满沉浸感**的 / **能引起用户共鸣**的 / 让用户感觉到 **充满艺术气息**的 / 有 **完整缜密的故事线**
- 玩家 **不需要过多的复杂的操作, 只需要选择不同的选项(当然也可以是其他的交互设计)**, 故事剧情必须围绕主题展开, 故事有主人公(由玩家来控制的角色), 也有互动电影类游戏的 **多结局多故事线** 设计
- 每个节点至少有一个选项, 至少 `75%` 的节点有两个选项(最后一个节点除外), 至少 `60%` 得节点有 `> 2` 个选项
- 用户在主页填写的所有参数, 都必须严格遵守
- 如果用户正则游戏中, 则必须保存游戏进度, 保证用户在游戏页刷新页面之后, 仍然可以继续游戏
- 禁止出现任何循环引用, 即不能出现 A 节点指向 B 节点, B 节点再指向 A 节点的情况
- 禁止出现空节点, 即不能出现没有选项的节点
- 禁止出现引用不存在节点的情况
- *AI 智能扩写* 时, 不能包含过量的剧透内容, 字数不能多于 150 字
- 剧情节点数量(范围)指的是: 最短故事线和最长故事线的长度, 可以理解为最快达到的结局需要的节点数量, 应该有至少 `80%` 的故事线都达到最长故事线的长度
- 剧情分支数量指的是: 故事线的数量, 可以理解为结局的数量
- *AI 生成角色*: 必须根据剧情生成角色, 剧情简介中有的角色必须保留, 在角色列表中, 即使用户输入了角色, 在生成时也要直接全部覆盖掉, 角色必须使用姓名, 禁止使用 *李同事* / *王工程师* 这种垃圾称呼, 但可以使用 `王哥` / `张总` 这种称呼

### 请求
调用的模型是 `glm-4.6v-flash`, 调用示例(`curl`):

```bash
curl -X POST \
https://open.bigmodel.cn/api/paas/v4/chat/completions \
-H "Authorization: Bearer your-api-key" \
-H "Content-Type: application/json" \
-d '{
  "model": "glm-4.6v-flash",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "image_url",
          "image_url": {
            "url": "https://cloudcovert-1305175928.cos.ap-guangzhou.myqcloud.com/%E5%9B%BE%E7%89%87grounding.PNG"
          }
        },
        {
          "type": "text",
          "text": "Where is the second bottle of beer from the right on the table?  Provide coordinates in [[xmin,ymin,xmax,ymax]] format"
        }
      ]
    }
  ],
  "thinking": {
    "type": "enabled"
  },
  "response_format": {
    "type": "json_object"
  }
}'
```

其中的 `your-api-key` 需要替换成自己的 API 密钥